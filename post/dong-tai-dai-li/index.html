<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ä»£ç†æ¨¡å¼ä¸jdkåŠ¨æ€ä»£ç†çš„å®ç° | Gridea</title>
<link rel="shortcut icon" href="https://bantu4me.github.io/favicon.ico?v=1610068313647">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://bantu4me.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="ä»£ç†æ¨¡å¼ä¸jdkåŠ¨æ€ä»£ç†çš„å®ç° | Gridea - Atom Feed" href="https://bantu4me.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="ä»£ç†æ¨¡å¼ä¸jdkåŠ¨æ€ä»£ç†çš„å®ç°
è¯•ç€æ€»ç»“ï¼Œå†™äº†ç¬¬ä¸€ç¯‡åšå®¢ï¼Œä¸å¯¹çš„åœ°æ–¹ï¼Œå¸Œæœ›çœ‹åˆ°çš„æœ‹å‹å¯ä»¥æŒ‡æ­£ï¼Œè°¢è°¢ã€‚ğŸ˜ƒ

ä»£ç†æ¨¡å¼
ä»£ç†æ¨¡å¼åœ¨ç¬”é¢è¯•ä¸­è¾ƒå¸¸è§ï¼Œç”¨äºå¯¹ç›®æ ‡å¯¹è±¡åŠŸèƒ½çš„å¢å¼ºã€‚springï¼Œmybatisç­‰æ¡†æ¶åº•å±‚ä¹Ÿéƒ½ä½¿ç”¨äº†åŠ¨æ€ä»£ç†ã€‚ä¸‹é¢ä»ä¸€ä¸ªé™..." />
    <meta name="keywords" content="java" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://bantu4me.github.io">
  <img class="avatar" src="https://bantu4me.github.io/images/avatar.png?v=1610068313647" alt="">
  </a>
  <h1 class="site-title">
    Gridea
  </h1>
  <p class="site-description">
    æ¸©æ•…è€ŒçŸ¥æ–°
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              ä»£ç†æ¨¡å¼ä¸jdkåŠ¨æ€ä»£ç†çš„å®ç°
            </h2>
            <div class="post-info">
              <span>
                2020-03-08
              </span>
              <span>
                21 min read
              </span>
              
                <a href="https://bantu4me.github.io/tag/bZ2UwMsxM/" class="post-tag">
                  # java
                </a>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <h1 id="ä»£ç†æ¨¡å¼ä¸jdkåŠ¨æ€ä»£ç†çš„å®ç°">ä»£ç†æ¨¡å¼ä¸jdkåŠ¨æ€ä»£ç†çš„å®ç°</h1>
<p>è¯•ç€æ€»ç»“ï¼Œå†™äº†ç¬¬ä¸€ç¯‡åšå®¢ï¼Œä¸å¯¹çš„åœ°æ–¹ï¼Œå¸Œæœ›çœ‹åˆ°çš„æœ‹å‹å¯ä»¥æŒ‡æ­£ï¼Œè°¢è°¢ã€‚ğŸ˜ƒ</p>
<!-- more -->
<h2 id="ä»£ç†æ¨¡å¼">ä»£ç†æ¨¡å¼</h2>
<p>ä»£ç†æ¨¡å¼åœ¨ç¬”é¢è¯•ä¸­è¾ƒå¸¸è§ï¼Œç”¨äºå¯¹ç›®æ ‡å¯¹è±¡åŠŸèƒ½çš„å¢å¼ºã€‚springï¼Œmybatisç­‰æ¡†æ¶åº•å±‚ä¹Ÿéƒ½ä½¿ç”¨äº†åŠ¨æ€ä»£ç†ã€‚ä¸‹é¢ä»ä¸€ä¸ªé™æ€ä»£ç†çš„ä¾‹å­çœ‹ä»£ç†æ¨¡å¼çš„ä½¿ç”¨ã€‚</p>
<h3 id="é™æ€ä»£ç†">é™æ€ä»£ç†</h3>
<p>å‡è®¾æœ‰ä¸€ä¸ªæ¥å£Daoï¼Œå®šä¹‰äº†ç›¸å…³çš„æŸ¥è¯¢é€»è¾‘ã€‚è¿˜æœ‰å®ç°äº†Daoæ¥å£çš„ä¸šåŠ¡ç±»ï¼ŒDaoImplã€‚</p>
<pre><code>/**
 * æ¨¡æ‹ŸæŸ¥è¯¢æ•°æ®åº“çš„ä¸šåŠ¡ç±»
 */
public interface Dao {
    public void select();
    public String selectByName(String name);
}

</code></pre>
<pre><code>public class DaoImpl implements Dao {
    @Override
    public void select() {
        System.out.println(&quot;å‡è£…æŸ¥è¯¢æ•°æ®åº“...&quot;);
    }
    @Override
    public String selectByName(String name) {
        System.out.println(&quot;å‡è£…æ ¹æ®åç§°æŸ¥è¯¢...&quot;);
        return name;
    }
}
</code></pre>
<p>éšç€ä¸šåŠ¡å‘å±•ï¼Œéœ€è¦å¯¹DaoImplçš„åŠŸèƒ½åšå¢å¼ºã€‚æ˜¾ç„¶ï¼Œæˆ‘ä»¬ä¸åº”è¯¥ç›´æ¥ä¿®æ”¹DaoImplç±»çš„æºç (è™½ç„¶ç°å®å¼€å‘ä¸­ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯æ€ä¹ˆç®€å•æ€ä¹ˆæ¥...)ã€‚æ‰€ä»¥å¯ä»¥é€šè¿‡ä»£ç†çš„å½¢å¼ï¼Œå¯¹å·²æœ‰çš„ä¸šåŠ¡ç±»çš„åŠŸèƒ½åšå¢å¼ºã€‚è¿™æ ·ç¬¦åˆå¼€æ”¾å°é—­çš„åŸåˆ™(å¯¹åŸåŠŸèƒ½çš„ä¿®æ”¹å°é—­ï¼Œå¯¹å…¶æ‰©å±•å¼€æ”¾)ã€‚å¦‚ä¸‹ï¼Œé€šè¿‡ä»£ç†å®ç°æ—¥å¿—åŠŸèƒ½çš„å¢å¼ºã€‚</p>
<ul>
<li>æä¾›ä¸€ä¸ªä¸åŸä¸šåŠ¡ç±»(DaoImpl)å®ç°ç›¸åŒæ¥å£(Dao)çš„ä»£ç†ç±»(LogProxy)</li>
<li>ä»£ç†ç±»(LogImpl)ä¸­æä¾›ä¸€ä¸ªåŸä¸šåŠ¡ç±»å‹(DaoImpl)çš„æˆå‘˜</li>
</ul>
<p>ç”±äºä¸åŸä¸šåŠ¡ç±»DaoImplå®ç°äº†ç›¸åŒæ¥å£Daoï¼Œæ‰€ä»¥LogImplæœ‰Daoæ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•ï¼›åˆå› ä¸ºä»£ç†ç±»(LogImpl)ä¸­æœ‰ä¸€ä¸ªåŸä¸šåŠ¡ç±»(DaoImpl)æˆå‘˜ï¼Œä¾¿å¯ä»¥å…ˆæ‰§è¡ŒLogImplçš„é€»è¾‘ï¼Œç„¶åæ‰§è¡ŒDaoImplçš„é€»è¾‘ã€‚è¿™æ ·ä¾¿å¯ä»¥åœ¨LogImplçš„æ–¹æ³•ä¸­å¯¹DaoImplçš„æ–¹æ³•åšå¢å¼ºã€‚</p>
<p>ä»¥ä¸Šè¿™æ®µè¯ï¼Œç”¨ä»£ç è¡¨ç¤ºä¾¿æ˜¯ä¸‹é¢çš„æ ·å­ï¼š</p>
<pre><code>public class LogProxy implements Dao {
    // åŸä¸šåŠ¡ç±»å‹æˆå‘˜(ä¹Ÿå¯ä»¥æ˜¯DaoImpl,å†™Daoä¸ºäº†æ›´å¥½çš„æŠ½è±¡)
    private Dao target;

    public LogProxy(Dao target) {
        this.target = target;
    }
    // å…ˆåšæ–¹æ³•å¢å¼º,å†åšåŸä¸šåŠ¡çš„å®ç°
    @Override
    public void select() {
        System.out.println(&quot;æ‰“å°æ—¥å¿—&quot;);
        target.select();
    }

    @Override
    public String selectByName(String name) {
        System.out.println(&quot;æ‰“å°æ—¥å¿—&quot;);
        return target.selectByName(name);
    }
}

</code></pre>
<p>é€šè¿‡Mainæ¨¡æ‹Ÿè°ƒç”¨</p>
<pre><code>public class Main {
    public static void main(String[] args) {
        // daoæ˜¯é€šè¿‡LogProxyä»£ç†è¿‡çš„
        Dao dao = new LogProxy(new DaoImpl());
        dao.select();
        System.out.println(&quot;============================&quot;);
        dao.selectByName(&quot;aaa&quot;);
    }
}

</code></pre>
<pre><code>æ‰“å°æ—¥å¿—
å‡è£…æŸ¥è¯¢æ•°æ®åº“...

============================

æ‰“å°æ—¥å¿—
å‡è£…æ ¹æ®åç§°æŸ¥è¯¢...
</code></pre>
<p>è¿™æ ·ä¾¿å®ç°äº†DaoImplåŠŸèƒ½çš„å¢å¼ºï¼Œè¾¾åˆ°äº†æ‰“å°æ—¥å¿—çš„ç›®çš„ã€‚</p>
<h4 id="é™æ€ä»£ç†çš„ç¼ºç‚¹">é™æ€ä»£ç†çš„ç¼ºç‚¹</h4>
<p>ä¸Šé¢é€šè¿‡é™æ€ä»£ç†å®ç°DaoImplåŠŸèƒ½çš„å¢å¼ºï¼Œä½†å…¶æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼šé’ˆå¯¹ä¸€ä¸ªåŠŸèƒ½çš„å¢å¼º(æ‰“å°æ—¥å¿—)ï¼Œéœ€è¦æ–°å¢ä¸€ä¸ªä»£ç†ç±»(LogProxy)ã€‚å¦‚æœè¿˜æœ‰æ–°çš„åŠŸèƒ½ï¼Œæ¯”å¦‚è®°å½•æ—¶é—´ï¼Œé‚£éœ€è¦æ–°çš„ä¸šåŠ¡ç±»ã€‚</p>
<pre><code>public class TimeProxy implements Dao {
    private Dao dao;
    public TimeProxy(Dao dao) {
        this.dao = dao;
    }
    @Override
    public void select() {
        System.out.println(&quot;è®°å½•æ—¶é—´...&quot;);
        dao.select();
    }
    @Override
    public String selectByName(String name) {
        System.out.println(&quot;è®°å½•æ—¶é—´&quot;);
        return dao.selectByName(&quot;aaa&quot;);
    }
}
</code></pre>
<p>åœ¨è°ƒç”¨æ¥å£çš„åœ°æ–¹ä¹Ÿéœ€è¦ç”¨æ–°å¢ä»£ç†ç±»åšåŒ…è£…</p>
<pre><code>public class Main {
    public static void main(String[] args) {
        Dao dao = new LogProxy(new DaoImpl());
        // ä½¿ç”¨æ–°ä»£ç†åŒ…è£…
        dao = new TimeProxy(dao);
        dao.select();
        dao.selectByName(&quot;aaa&quot;);
    }
}
</code></pre>
<pre><code>è®°å½•æ—¶é—´...
æ‰“å°æ—¥å¿—
å‡è£…æŸ¥è¯¢æ•°æ®åº“...

è®°å½•æ—¶é—´
æ‰“å°æ—¥å¿—
å‡è£…æ ¹æ®åç§°æŸ¥è¯¢...
</code></pre>
<p><mark>ç±»ä¼¼ä¸Šé¢çš„ä»£ç ï¼Œéšç€åŠŸèƒ½çš„æ‰©å±•ï¼Œä¼šè¡ç”Ÿå‡ºå¾ˆå¤šä»£ç†ç±»ã€‚è¿™æ˜¾ç„¶æ˜¯ä¸æ–¹ä¾¿çš„ã€‚</mark></p>
<h3 id="åŠ¨æ€ä»£ç†">åŠ¨æ€ä»£ç†</h3>
<p>ä¸ºäº†è§£å†³ä»£ç†æ¨¡å¼è¡ç”Ÿä»£ç†ç±»çš„ç¼ºç‚¹ï¼Œæœ‰äº†åŠ¨æ€ä»£ç†ã€‚å…ˆå°è¯•æ¨¡æ‹Ÿä¸€ä¸ªåŠ¨æ€ä»£ç†ï¼Œç„¶åå†çœ‹çœ‹jdkæä¾›çš„åŠ¨æ€ä»£ç†æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
<h4 id="æ¨¡æ‹ŸåŠ¨æ€ä»£ç†">æ¨¡æ‹ŸåŠ¨æ€ä»£ç†</h4>
<p>å…ˆæ¨¡æ‹Ÿä¸€ä¸ªç®€å•çš„åŠ¨æ€ä»£ç†ï¼Œå…·ä½“çš„æ€è·¯æ˜¯ï¼š</p>
<ol>
<li>é€šè¿‡javaä»£ç ï¼Œä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥ï¼ŒåŠ¨æ€ç”Ÿæˆä¸€ä¸ªä»£ç†ç±»çš„javaæ–‡ä»¶</li>
<li>ä½¿ç”¨ç±»åŠ è½½å™¨åŠ è½½ç”Ÿæˆçš„ä»£ç†ç±»</li>
<li>è°ƒç”¨åå°„APIç”Ÿæˆä»£ç†ç±»å¯¹è±¡</li>
<li>è°ƒç”¨ä»£ç†ç±»å®ç°ä¸šåŠ¡é€»è¾‘</li>
</ol>
<p>æ ¹æ®ä»¥ä¸Šçš„4æ­¥éª¤ï¼Œå†™å‡ºäº†ä¸‹é¢çš„ProxyUtilã€‚<mark>å…¶ä¸­æœ‰ä¸€ä¸ªnewInstanceæ–¹æ³•ï¼Œæ–¹æ³•åŒ…å«ä¸€ä¸ªObjectç±»å‹çš„å‚æ•°targetï¼Œè¿™ä¸ªtargetå°±æ˜¯è¢«ä»£ç†çš„å¯¹è±¡ã€‚é€šè¿‡targetï¼Œè°ƒç”¨ä¸€ç³»åˆ—åå°„APIï¼Œå¯ä»¥æ‹¿åˆ°å…¨è·¯å¾„åï¼Œæ–¹æ³•åï¼Œæ–¹æ³•å‚æ•°ç­‰ä¿¡æ¯ï¼Œç„¶åé€šè¿‡å­—ç¬¦ä¸²æ‹¼æ¥ï¼ŒæŒ‰ç…§é™æ€ä»£ç†çš„å½¢å¼ï¼Œç”Ÿæˆä¸€ä¸ªä»£ç†ç±»ã€‚ç„¶åç”Ÿæˆjavaæ–‡ä»¶ã€‚æœ€åä½¿ç”¨ç±»åŠ è½½å™¨å»åŠ è½½æ–‡ä»¶ç³»ç»Ÿé‡Œçš„javaæ–‡ä»¶ï¼Œè·å–å¯¹è±¡ä½¿ç”¨ã€‚</mark></p>
<pre><code>public class ProxyUtil {

    public static Object newInstance(Object target) throws IOException, ClassNotFoundException, InvocationTargetException, NoSuchMethodException, InstantiationException, IllegalAccessException {

        String line = &quot;\n&quot;;
        String tab = &quot;\t&quot;;
        // ä»£ç†å¯¹è±¡
        Object proxy = null;
        // ä»£ç†æ¥å£ ä»…æ¨¡æ‹Ÿå®ç°ä¸€ä¸ªæ¥å£çš„æƒ…å†µ
        Class targetInf = target.getClass().getInterfaces()[0];
        // ä»£ç†æ¥å£æ–¹æ³•
        Method[] methods = targetInf.getDeclaredMethods();
        // æ¥å£åç§°
        String infName = targetInf.getSimpleName();
        // ä»£ç†ç±»å®é™…å†…å®¹
        String content = &quot;&quot;;
        // åŒ…å
        String packageContent = &quot;package com.google;&quot;+line;
        // import ç±»
        String importContent = &quot;import &quot;+targetInf.getName()+&quot;;&quot;+line;
        // ç±»ç¬¬ä¸€è¡Œ{ public class ç±»å + æ¥å£ }
        String clazzFirstLineContent = &quot;public class $Proxy implements &quot;+infName+&quot;{&quot;+line;
        // ç±»å­—æ®µ
        String filedContent = tab+&quot;private &quot;+infName+&quot; target;&quot;+line;
        // æ„é€ å‡½æ•°
        String constructorContent = tab+&quot;public $Proxy (&quot;+infName+&quot; target){&quot;+line
                +tab+tab+&quot;this.target=target;&quot;+line
                +tab+&quot;}&quot;+line;
        // ä»£ç†æ¥å£æ–¹æ³•å†…å®¹
        StringBuilder methodContent = new StringBuilder();
        /**
         * éå†ä»£ç†æ¥å£æ–¹æ³•
         */
        for (Method method : methods) {
            // æ–¹æ³•è¿”å›ç±»å‹
            String returnTypeName = method.getReturnType().getSimpleName();
            // æ–¹æ³•å
            String methodName = method.getName();
            // æ–¹æ³•å‚æ•°
            Class&lt;?&gt;[] args = method.getParameterTypes();
            // ä»£ç†æ–¹æ³•å‚æ•°åˆ—è¡¨
            StringBuilder argsContent = new StringBuilder();
            // è¢«ä»£ç†æ–¹æ³•è°ƒç”¨æ—¶å®é™…å‚æ•°ä¼ å€¼
            StringBuilder paramsContent = new StringBuilder();
            String methodContentTmp;
            // å‚æ•°åç§°ä¸‹æ ‡ é¿å…å‚æ•°åç§°é‡å¤
            int flag = 0;
            for (Class&lt;?&gt; arg : args) {
                String temp = arg.getSimpleName();
                // String p1, String p2
                argsContent.append(temp).append(&quot; p&quot;).append(flag).append(&quot;,&quot;);
                paramsContent.append(&quot;p&quot;).append(flag).append(&quot;,&quot;);
                flag++;
            }

            if(argsContent.length()&gt;0){
                argsContent = new StringBuilder(argsContent.substring(0, argsContent.lastIndexOf(&quot;,&quot;) - 1));
                paramsContent = new StringBuilder(paramsContent.substring(0, paramsContent.lastIndexOf(&quot;,&quot;) - 1));
            }

            methodContentTmp = tab+&quot;public &quot;+returnTypeName+&quot; &quot;+methodName+&quot;(&quot;+argsContent+&quot;) {&quot;+line
                    +tab+tab+&quot;System.out.println(\&quot;åŠ¨æ€ä»£ç†çš„log...\&quot;);&quot;+line
                    +tab+tab+&quot;%s target.&quot;+methodName+&quot;(&quot;+paramsContent+&quot;);&quot;+line
                    +tab+&quot;}&quot;+line;
            // å¦‚æœæ–¹æ³•è¿”å›å€¼ä¸ºvoid åˆ™ä¸å†™return
            if(&quot;void&quot;.equals(returnTypeName)){
                methodContentTmp = String.format(methodContentTmp,&quot;&quot;);
            }else {
                methodContentTmp = String.format(methodContentTmp,&quot;return&quot;);
            }
            methodContent.append(methodContentTmp);
        }
        content=packageContent+importContent+clazzFirstLineContent+filedContent+constructorContent+methodContent+&quot;}&quot;;
        // ç”Ÿæˆjavaæ–‡ä»¶
        proxy = makeClassFile(content, target, targetInf);
        return proxy;
    }

    private static Object makeClassFile(String content, Object target, Class targetInf) throws IOException, ClassNotFoundException, NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException {
        
        // å°†æ–‡ä»¶ç”Ÿæˆåˆ°Dç›˜
        File file = new File(&quot;d:\\\\com\\\\google\\\\$Proxy.java&quot;);
        if(!file.exists()){
            file.createNewFile();
        }

        FileWriter fw = new FileWriter(file);
        fw.write(content);
        fw.flush();
        fw.close();

        // ç¼–è¯‘
        JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();
        StandardJavaFileManager fileMgr = compiler.getStandardFileManager(null, null, null);
        Iterable units = fileMgr.getJavaFileObjects(file);

        JavaCompiler.CompilationTask t = compiler.getTask(null, fileMgr, null, null, null, units);
        t.call();
        fileMgr.close();
        
        URL[] urls = new URL[]{new URL(&quot;file:D:\\\\&quot;)};
        // é€šè¿‡urlClassLoaderåŠ è½½
        URLClassLoader urlClassLoader = new URLClassLoader(urls);
        Class clazz = urlClassLoader.loadClass(&quot;com.google.$Proxy&quot;);
        
        //åå°„ç”Ÿæˆä»£ç†ç±»
        Constructor constructor = clazz.getConstructor(targetInf);
        return constructor.newInstance(target);
    }
</code></pre>
<p>é€šè¿‡ProxyUtilå®ç°çš„ä»£ç†ç±»ï¼Œåœ¨Dç›˜ä¸‹é¢ç”Ÿæˆäº†æ–‡ä»¶ï¼Œæ‰“å¼€æ–‡ä»¶æŸ¥çœ‹æ˜¯ä¸‹é¢çš„æ ·å­ï¼š</p>
<pre><code>package com.google;
import staticProxy.Dao;
public class $Proxy implements Dao{
	private Dao target;
	public $Proxy (Dao target){
		this.target=target;
	}
	public String selectByName(String p) {
		System.out.println(&quot;åŠ¨æ€ä»£ç†çš„log...&quot;);
		return target.selectByName(p);
	}
	public void select() {
		System.out.println(&quot;åŠ¨æ€ä»£ç†çš„log...&quot;);
		 target.select();
	}
}
</code></pre>
<p>è·Ÿæ‰‹å†™çš„ä»£ç†ç±»æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ã€‚</p>
<h4 id="å®ç°åŠ¨æ€çš„ä»£ç†é€»è¾‘">å®ç°åŠ¨æ€çš„ä»£ç†é€»è¾‘</h4>
<p>ä¸Šé¢çš„ä»£ç ï¼Œå¦‚æœç†è§£äº†æ€è·¯ï¼Œçœ‹æ˜ç™½äº†å®ç°ï¼Œå†æ¥è®¨è®ºä¸‹ä¸€ä¸ªé—®é¢˜ï¼šProxyUtilä¸­ï¼Œå®ç°çš„ä»£ç†æ–¹æ³•</p>
<blockquote>
<p>System.out.println(&quot;åŠ¨æ€ä»£ç†çš„log...&quot;);</p>
</blockquote>
<p>æ˜¯åœ¨ProxyUtilä¸­å†™æ­»çš„ï¼Œå®é™…ä½¿ç”¨ä¸­è¿™è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œä»£ç†çš„é€»è¾‘è¦æ ¹æ®ä¸šåŠ¡åŠ¨æ€ä¿®æ”¹ã€‚é‚£å¦‚ä½•ä¿®æ”¹ProxyUtilæ¥å®ç°åŠ¨æ€çš„ä»£ç†é€»è¾‘å‘¢ï¼Ÿå½’çº³ä¸€ä¸‹ï¼Œç›®å‰çš„ä»£ç†ç±»ä¸­çš„æ–¹æ³•ï¼Œæ˜¯ç±»ä¼¼ä¸‹é¢çš„ä¼ªä»£ç :</p>
<pre><code>public returnType methodName(args...){
    
    1.ä»£ç†é€»è¾‘
    2.åŸæ¥å£é€»è¾‘
    
}
</code></pre>
<p>å¦‚æœè¦æŠŠ1ä¸­çš„ä»£ç†é€»è¾‘åŠ¨æ€å®ç°ï¼Œä¸éš¾æƒ³åº”è¯¥è¦ä¼ å…¥ä¸€ä¸ªmethodï¼Œç„¶åè°ƒç”¨method.invoke()ï¼Œå°±å¯ä»¥å®ç°åŠ¨æ€çš„ä»£ç†é€»è¾‘ã€‚</p>
<pre><code>public returnType methodName(args...){
    
    //1.ä»£ç†é€»è¾‘
    
    method.invoke()
    
    2.åŸæ¥å£é€»è¾‘
    
}

</code></pre>
<p>è¿™æ ·çš„æ”¹é€ è¦è€ƒè™‘ä¸‹é¢çš„é—®é¢˜ï¼š</p>
<ol>
<li>methodçš„å®ä¾‹å¦‚ä½•å¾—åˆ°?</li>
<li>methodæ‰§è¡Œinvoke,éœ€è¦objectï¼Œobjectå¦‚ä½•å¾—åˆ°?</li>
<li>methodæ‰§è¡Œéœ€è¦å‚æ•°ï¼Œå‚æ•°å¦‚ä½•å¾—åˆ°?</li>
</ol>
<h4 id="jdkåŠ¨æ€ä»£ç†">jdkåŠ¨æ€ä»£ç†</h4>
<p>åˆ°ä¸Šé¢ä¸€æ­¥çš„æ—¶å€™ï¼Œæœ‰ç‚¹è¢«å¡ä½ã€‚äºæ˜¯å‚è€ƒäº†jdkåŠ¨æ€ä»£ç†çš„å®ç°æ–¹å¼ã€‚ä»¥ä¸‹æ˜¯jdkåŠ¨æ€ä»£ç†çš„ä½¿ç”¨ï¼š</p>
<ol>
<li>é€šè¿‡å®ç°InvocationHandleræ¥å£å®ç°åŠ¨æ€çš„ä»£ç†é€»è¾‘</li>
<li>InvocationHandleræ¥å£å®ç°ç±»ä¸­éœ€è¦æä¾›ä»£ç†ç±»çš„æˆå‘˜</li>
<li>é€šè¿‡Proxy.newInstance()ç”Ÿæˆä»£ç†å¯¹è±¡</li>
</ol>
<pre><code>public class MyHandler implements InvocationHandler {

    // æ¥æ”¶å…·ä½“çš„è¢«ä»£ç†å¯¹è±¡
    private Object object;
    public MyHandler(Object object) {
        this.object = object;
    }
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        // å¼€å‘è€…å®ç°åŠ¨æ€çš„ä»£ç†é€»è¾‘
        System.out.println(&quot;proxy...&quot;);
        // æ‰§è¡Œè¢«ä»£ç†å¯¹è±¡çš„åŸæ–¹æ³•
        return method.invoke(object, args);

    }
}

</code></pre>
<pre><code>public class Main {

    public static void main(String[] args) throws InterruptedException {
        //è¢«ä»£ç†å¯¹è±¡
        Dao dao = new DaoImpl();
        dao = (Dao) Proxy.newProxyInstance(Main.class.getClassLoader(), dao.getClass().getInterfaces(),new MyHandler(dao));
        dao.select();
    }

}
</code></pre>
<pre><code>proxy...
å‡è£…æŸ¥è¯¢æ•°æ®åº“...
</code></pre>
<h4 id="å‚è€ƒjdkåŠ¨æ€ä»£ç†">å‚è€ƒjdkåŠ¨æ€ä»£ç†</h4>
<p>Proxyç±»ï¼Œéœ€è¦ä¸‰ä¸ªå‚æ•°(ç±»åŠ è½½å™¨ï¼Œä»£ç†çš„æ¥å£ï¼ŒInvocationHandler)ï¼Œæœ€åæ˜¯æ‰§è¡ŒInvocationHandlerä¸­çš„invokeæ–¹æ³•ï¼Œå¦‚æœè‡ªå·±ä¹Ÿé€šè¿‡InvocationHandlerå®ç°ä¸€ä¸ªä»£ç†ç±»ï¼Œéœ€è¦å¦‚ä½•å®ç°å‘¢ï¼Ÿæˆ‘æƒ³åˆ°è¿™æ ·çš„ä»£ç†ç±»ï¼Œåº”è¯¥æ˜¯ä¸‹é¢ä¼ªä»£ç çš„æ ·å­ï¼š</p>
<pre><code>class ProxyClass implements ä»£ç†æ¥å£
    private InvocationHandler h

    // é‡æ–°æ¥å£æ–¹æ³•
    public returnType methodName(args...){
        
        Method m // å› ä¸ºæœ‰ä»£ç†æ¥å£ï¼Œå¯ä»¥åŠ¨æ€è·å–æ–¹æ³•å
        h.invoke(m,args)
    }
}
</code></pre>
<p>å¦‚æœç”Ÿæˆäº†ä¸Šé¢ä¼ªä»£ç å½¢å¼çš„ä»£ç†ç±»ï¼Œä¸å°±å¯ä»¥é€šè¿‡InvocationHandleræ¥å®ç°æ–¹æ³•å¢å¼ºäº†å—?æ ¹æ®ä¸Šé¢çš„ä¼ªä»£ç ï¼Œæ”¹é€ ProxyUtilç±»</p>
<pre><code>package myproxy.dominic;


import javax.tools.JavaCompiler;
import javax.tools.StandardJavaFileManager;
import javax.tools.ToolProvider;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.lang.reflect.Constructor;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.net.URL;
import java.net.URLClassLoader;
import java.text.MessageFormat;

/**
 * @className: ProxyUtil
 * @Descrepition: è€ƒè™‘å¦‚ä½•é€šè¿‡InvocationHandlerå®ç°åŠ¨æ€çš„ä»£ç†é€»è¾‘
 * @Author: lijie
 * Date: 2020/2/5 13:24
 **/
public class ProxyUtil {


    /**
     *
     * @return
     */
    public static Object newInstance(MyInvocationHandler h) throws IOException, ClassNotFoundException, InvocationTargetException, NoSuchMethodException, InstantiationException, IllegalAccessException {

        String line = &quot;\n&quot;;

        String tab = &quot;\t&quot;;

        // ä»£ç†å¯¹è±¡
        Object proxy = null;

        Object target = h.getTarget();

        // ä»£ç†æ¥å£ {è¿™é‡Œåº”è¯¥æ˜¯è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œç®€å•æ¨¡æ‹Ÿä¸€ä¸‹åªå–ä¸€ä¸ª}
        Class targetInf = target.getClass().getInterfaces()[0];

        // ä»£ç†æ¥å£æ–¹æ³•
        Method[] methods = targetInf.getDeclaredMethods();

        // æ¥å£åç§°
        String infName = targetInf.getSimpleName();

        // ä»£ç†ç±»å®é™…å†…å®¹
        String content = &quot;&quot;;

        // åŒ…å
        String packageContent = &quot;package com.google;&quot;+line;

        // import ç±»
        // å¯¼å…¥MyInvocationHand
        String importContent = &quot;import &quot;+targetInf.getName()+&quot;;&quot;+line+
                               &quot;import &quot;+MyInvocationHandler.class.getName()+&quot;;&quot;+line+
                               &quot;import java.lang.reflect.Method;&quot;+line;

        // ç±»ç¬¬ä¸€è¡Œ{ public class ç±»å + æ¥å£ }
        String clazzFirstLineContent = &quot;public class $Proxy implements &quot;+infName+&quot;{&quot;+line;

        // ç±»å­—æ®µ
        // åŠ¨æ€æ”¹é€ è¿™é‡Œæ”¹æˆInvocationHandler
        String filedContent = tab+&quot;private MyInvocationHandler h;&quot;+line;

        // æ„é€ å‡½æ•°
        String constructorContent =
                tab+&quot;public $Proxy (MyInvocationHandler h){&quot;+line
                +tab+tab+&quot;this.h=h;&quot;+line
                +tab+&quot;}&quot;+line
                // æ— å‚æ„é€ å‡½æ•°
                +tab+&quot;public $Proxy (){&quot;+line

                +tab+&quot;}&quot;+line
                ;

        // ä»£ç†æ¥å£æ–¹æ³•å†…å®¹
        StringBuilder methodContent = new StringBuilder();

        /**
         * éå†ä»£ç†æ¥å£æ–¹æ³•
         */
        for (Method method : methods) {

            // æ–¹æ³•è¿”å›ç±»å‹
            String returnTypeName = method.getReturnType().getSimpleName();

            // æ–¹æ³•å
            String methodName = method.getName();

            // æ–¹æ³•å‚æ•°
            Class&lt;?&gt;[] args = method.getParameterTypes();

            // ä»£ç†æ–¹æ³•å‚æ•°åˆ—è¡¨
            StringBuilder argsContent = new StringBuilder();
            // è¢«ä»£ç†æ–¹æ³•è°ƒç”¨æ—¶å®é™…å‚æ•°ä¼ å€¼
            StringBuilder paramsContent = new StringBuilder(&quot;Object[] args = {&quot;);

            String methodContentTmp;

            // å‚æ•°åç§°ä¸‹æ ‡ é¿å…å‚æ•°åç§°é‡å¤
            int flag = 0;

            for (Class&lt;?&gt; arg : args) {
                String temp = arg.getSimpleName();
                // String p1, String p2
                argsContent.append(temp).append(&quot; p&quot;).append(flag).append(&quot;,&quot;);
                paramsContent.append(&quot;p&quot;).append(flag).append(&quot;,&quot;);
                flag++;
            }

            if(argsContent.length()&gt;0){
                argsContent = new StringBuilder(argsContent.substring(0, argsContent.lastIndexOf(&quot;,&quot;) - 1));
                paramsContent = new StringBuilder(paramsContent.substring(0, paramsContent.lastIndexOf(&quot;,&quot;) - 1));
                paramsContent.append(&quot;}&quot;);
            }


            methodContentTmp = tab+&quot;public &quot;+returnTypeName+&quot; &quot;+methodName+&quot;(&quot;+argsContent+&quot;) {&quot;+line
                    +tab+tab+&quot;try{&quot;+line
                    /**
                     * è¿™é‡Œæ˜¯ä¸»è¦ä¸åŒç‚¹ï¼ŒåŠ¨æ€æ‰§è¡Œhandlerçš„invokeæ–¹æ³•
                     * éœ€è¦è·å–ä¸€ä¸ªMethodå¯¹è±¡ï¼Œç”¨äºåŠ¨æ€æ‰§è¡Œæ–¹æ³•
                     */
                    +tab+tab+tab+&quot;Class clazz = Class.forName(\&quot;&quot;+target.getClass().getName()+&quot;\&quot;);&quot;+line
                    +tab+tab+tab+&quot;Method method = clazz.getDeclaredMethod(\&quot;&quot;+methodName+&quot;\&quot; %s);&quot;+line
                    +&quot;%s&quot;
                    +tab+tab+tab+&quot;%s h.invoke(null,method,%s);&quot;+line

                    +tab+tab+&quot;}catch (Exception e) {&quot;+line
                    +tab+tab+tab+&quot;e.printStackTrace();&quot;+line
                    +tab+tab+&quot;}&quot;+line
                    +tab+tab+&quot;catch (Throwable throwable){&quot;+line
                    +tab+tab+tab+&quot;throwable.printStackTrace();&quot;+line
                    +tab+tab+&quot;}&quot;+line
                    +&quot;%s&quot;
                    +tab+&quot;}&quot;+line;
            // å¦‚æœæ–¹æ³•è¿”å›å€¼ä¸ºvoid åˆ™ä¸å†™return
            if(&quot;void&quot;.equals(returnTypeName)){
                methodContentTmp = String.format(methodContentTmp,&quot;&quot;,&quot;&quot;,&quot;&quot;,null,&quot;&quot;);
            }else {
                methodContentTmp = String.format(methodContentTmp,&quot;,&quot;+returnTypeName+&quot;.class&quot;,tab+tab+tab+paramsContent+&quot;;&quot;+line,&quot;return (String)&quot;,&quot;args&quot;,line+tab+tab+&quot;return null;&quot;+line);
            }

            methodContent.append(methodContentTmp);

        }

        content=packageContent+importContent+clazzFirstLineContent+filedContent+constructorContent+methodContent+&quot;}&quot;;

        // ç”Ÿæˆjavaæ–‡ä»¶
        proxy = makeClassFile(content, h, targetInf);


        return proxy;
    }


    private static Object makeClassFile(String content, Object target, Class targetInf) throws IOException, ClassNotFoundException, NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException {

        File file = new File(&quot;d:\\\\com\\\\google\\\\$Proxy.java&quot;);
        if(!file.exists()){
            file.createNewFile();
        }

        // å†™æ–‡ä»¶
        FileWriter fw = new FileWriter(file);
        fw.write(content);
        fw.flush();
        fw.close();

        // ç¼–è¯‘
        JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();

        StandardJavaFileManager fileMgr = compiler.getStandardFileManager(null, null, null);
        Iterable units = fileMgr.getJavaFileObjects(file);

        JavaCompiler.CompilationTask t = compiler.getTask(null, fileMgr, null, null, null, units);
        t.call();
        fileMgr.close();

        URL[] urls = new URL[]{new URL(&quot;file:D:\\\\&quot;)};
        URLClassLoader urlClassLoader = new URLClassLoader(urls);
        Class clazz = urlClassLoader.loadClass(&quot;com.google.$Proxy&quot;);

        // é€šè¿‡åå°„ä»£ç ï¼Œè°ƒç”¨æ„é€ å‡½æ•°ï¼Œä¼ å…¥çš„å‚æ•°(MyInvocationHandler.class)
        // è¿™å’ŒjdkåŠ¨æ€ä»£ç†çš„æºç æ˜¯ä¸€è‡´çš„
        /**
         *return cons.newInstance(new Object[]{h});
         */
        Constructor constructor = clazz.getConstructor(MyInvocationHandler.class);

        return constructor.newInstance(target);

    }



}

</code></pre>
<p>æ”¹é€ çš„ProxyUtilä¹ŸæŒºç»•çš„ï¼Œæ ¸å¿ƒçš„ç›®çš„æ˜¯ï¼Œè®©ProxyUtilæ ¹æ®ä¼ å…¥çš„å‚æ•°ï¼ŒåŠ¨æ€è§£æå¾—åˆ°æ–¹æ³•ã€‚è€Œä»£ç†çš„é€»è¾‘é€šè¿‡InvocationHandleræ¥äº¤ç»™å¼€å‘è€…å®ç°ã€‚æ”¹é€ è¿‡å¥½çš„ProxyUtilç”Ÿæˆçš„ä»£ç†ç±»æ–‡ä»¶ï¼Œæ˜¯ä¸‹é¢çš„æ ·å­ï¼š</p>
<pre><code>package com.google;
import staticProxy.Dao;
import myproxy.dominic.MyInvocationHandler;
import java.lang.reflect.Method;
public class $Proxy implements Dao{
    // è‡ªå®šä¹‰çš„ä¸€ä¸ªHandlerï¼Œè·Ÿjdkä¸­çš„InvocationHandlerä¸€æ ·
	private MyInvocationHandler h;
	public $Proxy (MyInvocationHandler h){
		this.h=h;
	}
	public $Proxy (){
	}
	public void select() {
		try{
			Class clazz = Class.forName(&quot;staticProxy.DaoImpl&quot;);
			Method method = clazz.getDeclaredMethod(&quot;select&quot; );
			 h.invoke(null,method,null);
		}catch (Exception e) {
			e.printStackTrace();
		}
		catch (Throwable throwable){
			throwable.printStackTrace();
		}
	}
	public String selectByName(String p) {
		try{
			Class clazz = Class.forName(&quot;staticProxy.DaoImpl&quot;);
			Method method = clazz.getDeclaredMethod(&quot;selectByName&quot; ,String.class);
			Object[] args = {p};
			return (String) h.invoke(null,method,args);
		}catch (Exception e) {
			e.printStackTrace();
		}
		catch (Throwable throwable){
			throwable.printStackTrace();
		}

		return null;
	}
}

</code></pre>
<p>è¿™ä¸ªç±»çš„å¯¹è±¡ï¼Œæœ€åä¼šæ‰§è¡ŒMyInvocationHandlerå®ä¾‹çš„invokeæ–¹æ³•ï¼Œé‚£å¼€å‘è€…é€šè¿‡MyInvocationHandlerï¼Œä¾¿å¯ä»¥å®ç°æ–¹æ³•çš„åŠ¨æ€ä»£ç†ã€‚</p>
<p>MyInvocationHandlerï¼Œå‚è€ƒäº†jdkä¸­InvocationHandlerã€‚</p>
<pre><code>public interface MyInvocationHandler {

    /**
     * invoke jdké‡Œé¢çš„è¿™ä¸ªproxy ä¸ºä»€ä¹ˆæ˜¯ä»£ç†å¯¹è±¡ï¼Œè€Œä¸æ˜¯è¢«ä»£ç†å¯¹è±¡ï¼Ÿä»£ç†å¯¹è±¡çš„è¯ï¼Œæ„Ÿè§‰ä¸æ€ä¹ˆä½¿ç”¨åˆ°
     * @param proxy
     * @param method
     * @param args
     * @return
     * @throws Throwable
     */
    public Object invoke(Object proxy, Method method, Object[] args)
            throws Throwable;


    public Object getTarget();

}
</code></pre>
<pre><code>public class MyInvocationHandlerImpl implements MyInvocationHandler {

    private Object target;

    public MyInvocationHandlerImpl(Object target) {
        this.target = target;
    }

    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        System.out.println(&quot;å¼€å§‹åšä»£ç†äº†ã€‚ã€‚ã€‚&quot;);
        Object result = method.invoke(this.target, args);
        System.out.println(&quot;ä»£ç†ç»“æŸã€‚ã€‚ã€‚&quot;);
        return result;
    }


    /**
     * è·å–ä»£ç†çš„ç›®æ ‡å¯¹è±¡
     * @return
     */
    @Override
    public Object getTarget() {
        return this.target;
    }
}
</code></pre>
<pre><code>public class Main {

    public static void main(String[] args) throws NoSuchMethodException, IOException, InstantiationException, IllegalAccessException, InvocationTargetException, ClassNotFoundException {

        Dao dao = (Dao) ProxyUtil.newInstance(new MyInvocationHandlerImpl(new DaoImpl()));
        dao.select();

        System.out.println(&quot;===============================================&quot;);

        dao.selectByName(&quot;test&quot;);

        System.out.println(&quot;===============================================&quot;);

    }
}
</code></pre>
<p>è¾“å‡ºç»“æœ</p>
<pre><code>å¼€å§‹åšä»£ç†äº†ã€‚ã€‚ã€‚
å‡è£…æŸ¥è¯¢æ•°æ®åº“...
ä»£ç†ç»“æŸã€‚ã€‚ã€‚

===============================================

å¼€å§‹åšä»£ç†äº†ã€‚ã€‚ã€‚
å‡è£…æ ¹æ®åç§°æŸ¥è¯¢...
ä»£ç†ç»“æŸã€‚ã€‚ã€‚

===============================================
</code></pre>
<p>è¿™æ ·çš„ä½¿ç”¨æ–¹å¼ï¼Œå°±è·ŸjdkåŠ¨æ€ä»£ç†æ˜¯ä¸€æ ·çš„äº†ã€‚</p>
<h2 id="jdkåŠ¨æ€ä»£ç†æºç ">jdkåŠ¨æ€ä»£ç†æºç </h2>
<p>ä¸Šé¢è¯´ï¼Œè‡ªå®šä¹‰çš„åŠ¨æ€ä»£ç†ï¼Œè·Ÿjdkä»£ç†æœ¬è´¨æ˜¯ä¸€æ ·çš„(æœ¬æ¥å°±æ˜¯çœ‹äº†æºç ä»¿é€ å®ç°çš„)ã€‚ä¸‹é¢çœ‹çœ‹jdkçš„åŠ¨æ€ä»£ç†å¦‚ä½•åšçš„ã€‚</p>
<p>è·Ÿè¸ªProxy.newInstanceæ–¹æ³•æŸ¥çœ‹æºç ï¼š</p>
<p><img src="https://s2.ax1x.com/2020/02/17/3iEhnI.png" alt="3iEhnI.png" loading="lazy"><br>
<img src="https://s2.ax1x.com/2020/02/17/3iEWjA.png" alt="3iEWjA.png" loading="lazy"><br>
<img src="https://s2.ax1x.com/2020/02/17/3iERcd.png" alt="3iERcd.png" loading="lazy"><br>
<img src="https://s2.ax1x.com/2020/02/17/3iE21H.png" alt="3iE21H.png" loading="lazy"><br>
applyæ–¹æ³•ä¸­æœ€é‡è¦çš„éƒ¨åˆ†<br>
<img src="https://s2.ax1x.com/2020/02/17/3iePX9.png" alt="3iePX9.png" loading="lazy"><br>
ProxyGenerator.generateProxyClass()æ–¹æ³•ç”Ÿæˆäº†ä»£ç†ç±»çš„å­—èŠ‚ç ï¼Œæœ€åé€šè¿‡defineClass0()ç”Ÿæˆä»£ç†å¯¹è±¡ã€‚å…¶ä¸­definClass0çš„æ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼Œç½‘ä¸Šèµ„æ–™è¯´å…¶ä¸­ä½¿ç”¨äº†asmç›¸å…³çš„æŠ€æœ¯ï¼Œå°±æ²¡æœ‰ç»§ç»­äº†è§£äº†(éœ€è¦openjdkæŸ¥çœ‹ç›¸å…³Cä»£ç )</p>
<pre><code>private static native Class&lt;?&gt; defineClass0(ClassLoader loader, String name,
                                                byte[] b, int off, int len);
</code></pre>
<p>ä¸‹é¢çœ‹çœ‹ï¼Œè°ƒç”¨ProxyGenerator.generateProxyClass()ç”Ÿæˆçš„ä¸œè¥¿é•¿ä»€ä¹ˆæ ·ï¼Œæ–¹æ³•éœ€è¦çš„å‚æ•°æ˜¯ç±»åï¼Œæ¥å£ï¼Œæ ‡è¯†ã€‚ä¸‹é¢ä»£ç ç”Ÿæˆç±»åä¸ºProxyCaseçš„ç±»ï¼Œä»£ç†äº†Daoæ¥å£çš„å®ç°ï¼Œç„¶åæŠŠå­—èŠ‚ç ç”Ÿæˆåˆ°Dç›˜ç›®å½•ä¸‹ã€‚</p>
<pre><code>@Test
public void test5() throws IOException {
    // ç”ŸæˆLogServiceçš„ä»£ç†å¯¹è±¡ï¼Œå‘½åä¸ºProxyCase
    byte[] bytes = ProxyGenerator.generateProxyClass(&quot;ProxyCase&quot;, new Class[]{Dao.class}, 0);

    // æ–‡ä»¶å†™åˆ°Dç›˜
    File file = new File(&quot;D:\\ProxyCase.class&quot;);
    if(!file.exists()){
        file.createNewFile();
    }


    FileOutputStream outputStream = new FileOutputStream(file);

    outputStream.write(bytes);
    outputStream.flush();
    outputStream.close();
}
</code></pre>
<p>ç”Ÿæˆçš„classæ–‡ä»¶ï¼Œé€šè¿‡åç¼–è¯‘å·¥å…·æ‰“å¼€</p>
<pre><code>class ProxyCase extends Proxy implements Dao {
    // methodçš„åˆå§‹åŒ–åœ¨ä¸‹é¢çš„é™æ€åŸŸä¸­
    private static Method m1;
    private static Method m4;
    private static Method m2;
    private static Method m3;
    private static Method m0;
    
    // jdkä¹Ÿæ˜¯ä½¿ç”¨äº†åå°„çš„apiè·å–methodå®ä¾‹
    static {
        try {
            m1 = Class.forName(&quot;java.lang.Object&quot;).getMethod(&quot;equals&quot;, Class.forName(&quot;java.lang.Object&quot;));
            m4 = Class.forName(&quot;staticProxy.Dao&quot;).getMethod(&quot;selectByName&quot;, Class.forName(&quot;java.lang.String&quot;));
            m2 = Class.forName(&quot;java.lang.Object&quot;).getMethod(&quot;toString&quot;);
            m3 = Class.forName(&quot;staticProxy.Dao&quot;).getMethod(&quot;select&quot;);
            m0 = Class.forName(&quot;java.lang.Object&quot;).getMethod(&quot;hashCode&quot;);
        } catch (NoSuchMethodException var2) {
            throw new NoSuchMethodError(var2.getMessage());
        } catch (ClassNotFoundException var3) {
            throw new NoClassDefFoundError(var3.getMessage());
        }
    }

    // jdkç”Ÿæˆçš„ä»£ç†å¯¹è±¡ï¼Œç»§æ‰¿äº†Proxyï¼ŒInvocationHandleræˆå‘˜åœ¨çˆ¶ç±»Proxyä¸­å®šä¹‰
    public ProxyCase(InvocationHandler var1) throws  {
        super(var1);
    }
    
    public final void select() throws  {
        try {
            super.h.invoke(this, m3, (Object[])null);
        } catch (RuntimeException | Error var2) {
            throw var2;
        } catch (Throwable var3) {
            throw new UndeclaredThrowableException(var3);
        }
    }
    
    public final String selectByName(String var1) throws  {
        try {
            return (String)super.h.invoke(this, m4, new Object[]{var1});
        } catch (RuntimeException | Error var3) {
            throw var3;
        } catch (Throwable var4) {
            throw new UndeclaredThrowableException(var4);
        }
    }
    
    // ä¸‹é¢çš„æ–¹æ³•å¯ä»¥ä¸ç”¨åœ¨æ„
    public final boolean equals(Object var1) throws  {
        try {
            return (Boolean)super.h.invoke(this, m1, new Object[]{var1});
        } catch (RuntimeException | Error var3) {
            throw var3;
        } catch (Throwable var4) {
            throw new UndeclaredThrowableException(var4);
        }
    }

    public final String toString() throws  {
        try {
            return (String)super.h.invoke(this, m2, (Object[])null);
        } catch (RuntimeException | Error var2) {
            throw var2;
        } catch (Throwable var3) {
            throw new UndeclaredThrowableException(var3);
        }
    }

    public final int hashCode() throws  {
        try {
            return (Integer)super.h.invoke(this, m0, (Object[])null);
        } catch (RuntimeException | Error var2) {
            throw var2;
        } catch (Throwable var3) {
            throw new UndeclaredThrowableException(var3);
        }
    }

    
}
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢ä»£ç ä¸­å®é™…å¯¹æ–¹æ³•å¢å¼ºçš„åœ°æ–¹ï¼Œè·Ÿä¸Šé¢æ¨¡æ‹Ÿçš„æ˜¯å·®ä¸å¤šçš„ï¼Œéƒ½æ˜¯å€ŸåŠ©äº†InvocationHandleræ¥å®ç°äº†ä»£ç†é€»è¾‘çš„åŠ¨æ€ã€‚</p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F%E4%B8%8Ejdk%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E7%9A%84%E5%AE%9E%E7%8E%B0">ä»£ç†æ¨¡å¼ä¸jdkåŠ¨æ€ä»£ç†çš„å®ç°</a>
<ul>
<li><a href="#%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F">ä»£ç†æ¨¡å¼</a>
<ul>
<li><a href="#%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86">é™æ€ä»£ç†</a>
<ul>
<li><a href="#%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86%E7%9A%84%E7%BC%BA%E7%82%B9">é™æ€ä»£ç†çš„ç¼ºç‚¹</a></li>
</ul>
</li>
<li><a href="#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86">åŠ¨æ€ä»£ç†</a>
<ul>
<li><a href="#%E6%A8%A1%E6%8B%9F%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86">æ¨¡æ‹ŸåŠ¨æ€ä»£ç†</a></li>
<li><a href="#%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E7%9A%84%E4%BB%A3%E7%90%86%E9%80%BB%E8%BE%91">å®ç°åŠ¨æ€çš„ä»£ç†é€»è¾‘</a></li>
<li><a href="#jdk%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86">jdkåŠ¨æ€ä»£ç†</a></li>
<li><a href="#%E5%8F%82%E8%80%83jdk%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86">å‚è€ƒjdkåŠ¨æ€ä»£ç†</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#jdk%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%BA%90%E7%A0%81">jdkåŠ¨æ€ä»£ç†æºç </a></li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        

        
          
            <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<div id="gitalk-container"></div>

<script>

  var gitalk = new Gitalk({
    clientID: 'c380d5eda62f3e2bfa70',
    clientSecret: '77ebd87e649fb81e785596200a107ea71388b671',
    repo: 'pageComment',
    owner: 'bantu4me',
    admin: ['bantu4me'],
    id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
  })

  gitalk.render('gitalk-container')

</script>

          

          
        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://bantu4me.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
